<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Interval Quiz</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; display: flex; justify-content: center; padding-top: 50px; }
        .container { background: white; width: 600px; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-play { background: #28a745; color: white; width: 100%; font-size: 18px; margin-bottom: 20px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .option-btn { background: #e9ecef; border: 1px solid #ccc; padding: 15px; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { background: #dbe2e8; }
        .option-btn.selected { background: #007bff; color: white; }
        
        /* Review Mode Styles */
        .review-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .correct { color: green; font-weight: bold; }
        .wrong { color: red; text-decoration: line-through; }
        .correction { color: green; margin-left: 10px; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <!-- 1. LOGIN SCREEN -->
    <div id="login-view">
        <h1>ðŸŽµ Interval Training</h1>
        <p>Enter your name to begin:</p>
        <input type="text" id="username" placeholder="Student Name" style="padding:10px; width:80%">
        <br><br>
        <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
    </div>

    <!-- 2. QUIZ SCREEN -->
    <div id="quiz-view" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span id="q-progress">Question 1/10</span>
            <span id="s-name-display"></span>
        </div>
        
        <button class="btn btn-play" onclick="playCurrentAudio()">â–¶ Play Audio</button>
        
        <div class="options-grid" id="options-container">
            <!-- Buttons generated by JS -->
        </div>
        
        <br>
        <button class="btn btn-primary" style="float:right" onclick="submitAnswer()">Next ></button>
    </div>

    <!-- 3. RESULT/REVIEW SCREEN -->
    <div id="result-view" class="hidden">
        <h1>Quiz Complete!</h1>
        <h2 id="final-score">Score: 80%</h2>
        <p>Review your answers below (Click â–¶ to listen again):</p>
        <div id="review-list"></div>
        <br>
        <button class="btn btn-primary" onclick="location.reload()">Take Another Quiz</button>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION (PASTE YOURS HERE) ---
    const firebaseConfig = {
  apiKey: "AIzaSyBBNghZXIPgxege7wu_Od9fJi3KRR2ekLU",
  authDomain: "auralis-14b53.firebaseapp.com",
  projectId: "auralis-14b53",
  storageBucket: "auralis-14b53.firebasestorage.app",
  messagingSenderId: "209022640182",
  appId: "1:209022640182:web:04359233f85da62dc0b897"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. AUDIO BANK CONFIGURATION ---
    // List ALL your filenames here. The code detects the answer based on the prefix (e.g., 'm2_').
    const audioFiles = [
        "m2_exercise1.mp3", "M2_piano.mp3", "m3_test.mp3", "M3_vocal.mp3",
        "P4_brass.mp3", "aug4_tritone.mp3", "P5_strings.mp3", 
        "m6_descending.mp3", "M6_ascending.mp3", "m7_jazz.mp3", "M7_pop.mp3",
        // ... Add your hundreds of files here
    ];

    const labels = {
        "m2": "Minor 2nd", "M2": "Major 2nd", "m3": "Minor 3rd", "M3": "Major 3rd",
        "P4": "Perfect 4th", "aug4": "Aug 4th", "P5": "Perfect 5th",
        "m6": "Minor 6th", "M6": "Major 6th", "m7": "Minor 7th", "M7": "Major 7th"
    };

    // --- 3. APP STATE ---
    let studentName = "";
    let quizQueue = []; // Holds the 10 selected questions
    let currentQIndex = 0;
    let userAnswers = []; // Stores { correct: "M3", chosen: "P4", audio: "..." }
    let currentAudioObj = null;
    let selectedOption = null;

    function startQuiz() {
        studentName = document.getElementById('username').value;
        if(!studentName) return alert("Please enter a name");

        // Randomly select 10 audio files
        quizQueue = [];
        for(let i=0; i<10; i++) {
            const randomFile = audioFiles[Math.floor(Math.random() * audioFiles.length)];
            // Extract answer from filename (e.g., "m2_test.mp3" -> "m2")
            const answerKey = randomFile.split('_')[0]; 
            quizQueue.push({ file: "audio/" + randomFile, answerKey: answerKey });
        }

        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('quiz-view').classList.remove('hidden');
        document.getElementById('s-name-display').innerText = studentName;
        loadQuestion();
    }

    function loadQuestion() {
        selectedOption = null;
        document.getElementById('q-progress').innerText = `Question ${currentQIndex + 1} / 10`;
        
        // Build Option Buttons
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        Object.keys(labels).forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = labels[key];
            btn.onclick = () => {
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedOption = key;
            };
            container.appendChild(btn);
        });

        playCurrentAudio();
    }

    function playCurrentAudio() {
        if(currentAudioObj) currentAudioObj.pause();
        currentAudioObj = new Audio(quizQueue[currentQIndex].file);
        currentAudioObj.play();
    }

    function playReviewAudio(file) {
        new Audio(file).play();
    }

    function submitAnswer() {
        if(!selectedOption) return alert("Please select an interval.");

        // Record Answer
        const currentQ = quizQueue[currentQIndex];
        userAnswers.push({
            questionNum: currentQIndex + 1,
            audioFile: currentQ.file,
            correctKey: currentQ.answerKey,
            correctLabel: labels[currentQ.answerKey],
            chosenKey: selectedOption,
            chosenLabel: labels[selectedOption],
            isCorrect: currentQ.answerKey === selectedOption
        });

        currentQIndex++;
        if(currentQIndex < 10) {
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    function finishQuiz() {
        document.getElementById('quiz-view').classList.add('hidden');
        document.getElementById('result-view').classList.remove('hidden');

        // Calculate Score
        const scoreCount = userAnswers.filter(a => a.isCorrect).length;
        const scorePercent = (scoreCount / 10) * 100;
        document.getElementById('final-score').innerText = `Score: ${scorePercent}%`;

        // Save to Database
        db.collection("quiz_results").add({
            student: studentName,
            score: scorePercent,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            details: userAnswers // Saving full detail for teacher dashboard
        });

        // Generate Review List
        const reviewList = document.getElementById('review-list');
        userAnswers.forEach(ans => {
            const div = document.createElement('div');
            div.className = 'review-item';
            
            let html = `<button class="btn" style="padding:5px 10px" onclick="playReviewAudio('${ans.audioFile}')">â–¶</button> `;
            
            if(ans.isCorrect) {
                html += `<span class="correct">âœ” Correct (${ans.correctLabel})</span>`;
            } else {
                html += `<span class="wrong">âœ– You picked: ${ans.chosenLabel}</span> <span class="correction">Should be: ${ans.correctLabel}</span>`;
            }
            div.innerHTML = html;
            reviewList.appendChild(div);
        });
    }
</script>
</body>
</html>